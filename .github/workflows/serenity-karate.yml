name: API Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run API tests with CompleteReportRunner
      run: mvn test -Dtest=CompleteReportRunner
      continue-on-error: true

    - name: Generate Test Summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Tests executed:** $(find target/surefire-reports -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'tests="[^"]*"' | cut -d'"' -f2 | awk '{sum+=$1} END {print sum}')" >> $GITHUB_STEP_SUMMARY
        echo "**Tests failed:** $(find target/surefire-reports -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'failures="[^"]*"' | cut -d'"' -f2 | awk '{sum+=$1} END {print sum}')" >> $GITHUB_STEP_SUMMARY
        echo "**Tests passed:** $(find target/surefire-reports -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'tests="[^"]*"' | cut -d'"' -f2 | awk '{sum+=$1} END {print sum}') - $(find target/surefire-reports -name "*.xml" -exec grep -h "testsuite" {} \; | grep -o 'failures="[^"]*"' | cut -d'"' -f2 | awk '{sum+=$1} END {print sum}')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“Š **Download the Karate HTML Report from the Artifacts section below to view detailed results**" >> $GITHUB_STEP_SUMMARY

    - name: Upload Karate HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: karate-html-report
        path: target/karate-reports/
        retention-days: 30

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: target/surefire-reports/
        retention-days: 30

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let summary = '## ğŸ§ª API Tests Results\n\n';
          
          try {
            const reportPath = 'target/karate-reports/karate-summary.html';
            if (fs.existsSync(reportPath)) {
              summary += 'âœ… **Tests completed successfully!**\n\n';
              summary += 'ğŸ“Š **Download the detailed HTML report from the Actions artifacts**\n\n';
              summary += 'ğŸ”— [View Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            } else {
              summary += 'âŒ **Tests failed or report not generated**\n\n';
              summary += 'ğŸ”— [View Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            }
          } catch (error) {
            summary += 'âŒ **Error generating report**\n\n';
            summary += 'ğŸ”— [View Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download Karate Reports
      uses: actions/download-artifact@v4
      with:
        name: karate-html-report
        path: ./karate-reports
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Create index.html
      run: |
        mkdir -p public
        if [ -d "./karate-reports" ]; then
          cp -r ./karate-reports/* ./public/
          echo "<html><head><title>API Test Reports</title><meta http-equiv='refresh' content='0;url=karate-summary.html'></head><body><p>Redirecting to <a href='karate-summary.html'>test reports</a>...</p></body></html>" > ./public/index.html
        else
          echo "<html><body><h1>API Test Reports</h1><p>No test reports available at the moment.</p><p>Reports will appear here after successful test runs.</p></body></html>" > ./public/index.html
        fi
    
    - name: Upload site
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
